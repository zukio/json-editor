<!DOCTYPE html>
<html lang="ja">
  <title>Edit Settings</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
    crossorigin="anonymous"
  />
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0"
  />

  <body class="p-5">
    <div class="container">
      <button id="open" type="button" class="btn btn-primary btn-sm">
        <span class="material-symbols-outlined align-middle"> folder_open </span>
        Open File
      </button>
      <div class="text-end mb-3"><a href="#" id="reload" class="d-none">èª­ã¿ç›´ã™ğŸ”„</a></div>

      <form id="editForm" name="editForm" class="position-relative needs-validation">
        <button id="save" class="btn btn-secondary w-100" type="submit" disabled>
          Save
          <span class="material-symbols-outlined align-middle"> download </span>
        </button>
        <dl id="container" class="pt-3 m-0"></dl>
      </form>
      <div class="w-100 d-flex justify-content-center">
        <button id="add" class="btn btn-outline-primary rounded-circle d-none" type="button">+</button>
      </div>
    </div>

    <script type="module">
      // ============================================
      // ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãƒ‘ãƒ¼ãƒˆ
      // --------------------------------------------
      // ğŸ’¬ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºæ–¹æ³•ãŒã‚ã‹ã‚‰ãªã„å ´åˆã¯ç©º {} ã«ã—ã¦ãã ã•ã„
      // [ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å]:{ initial:ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤, selection:é¸æŠè‚¢(ç•¥å¯), required:å¿…é ˆ(ç•¥å¯) }
      const fieldConfig = {
        "Order": { initial: -1, required: true },
        "Url": { initial: "", required: true },
        "allowedUri": { initial: "", required: true },
        "AllowsTransparency": { initial: true },
        "ShowInTaskbar": { initial: false },
        "WindowStyle": {
          initial: "None",
          selection: ["None", "SingleBorderWindow", "ThreeDBorderWindow", "ToolWindow"],
        },
        "ResizeMode": {
          initial: "NoResize",
          selection: ["NoResize", "CanMinimize", "CanResize", "CanResizeWithGrip"],
        },
        "WindowState": {
          initial: "Maximized",
          selection: ["Maximized", "Normal", "Minimized"],
          required: true,
        },
        "NormalizePosition": {
          initial: {
            "X": 0,
            "Y": 0,
            "Width": 0,
            "Height": 0,
          },
          required: true,
        },
        "auth": {
          initial: {
            "Name": "",
            "Pass": "",
          },
        },
      };

      // ============================================
      // ä»¥ä¸‹ã¯ç·¨é›†ä¸è¦
      // --------------------------------------------
      // ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºç”¨ã‚µãƒ³ãƒ—ãƒ«ãŒå®£è¨€ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹
      const defineSample = () =>
        typeof fieldConfig !== "undefined" && fieldConfig !== null && Object.keys(fieldConfig).length > 0;

      // Json keyã‚’labelã«ã€valueã‚’inputã«ç½®ãæ›ãˆã‚‹
      function translate(id, key, value = null) {
        // fieldConfig ãŒå®£è¨€ã•ã‚Œã¦ã„ã‚Œã°
        if (defineSample) {
          // fieldConfig ã«å€£ã£ã¦ç¿»è¨³
          return translateWithSample(id, key, value);
        } else {
          // key ã ã‘æ¸¡ã•ã‚ŒãŸï¼ˆvalue ãŒãªã„ï¼‰å ´åˆã¯ key ã‚’ç¿»è¨³ã—ãŸãƒ©ãƒ™ãƒ«ã‚’è¿”ã™
          const needLabel = (value ?? null) == null;
          if (needLabel) return key;
          // value ãŒã‚ã‚‹å ´åˆã¯ å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¿”ã™
          return createInput(id, value);
        }
      }

      // Json(Key) ã‚’æ—¥æœ¬èªã«ç¿»è¨³
      function translateWithSample(id, key, value = null) {
        // key ã ã‘æ¸¡ã•ã‚ŒãŸï¼ˆvalue ãŒãªã„ï¼‰å ´åˆã¯ key ã‚’ç¿»è¨³ã—ãŸãƒ©ãƒ™ãƒ«ã‚’è¿”ã™
        const needLabel = (value ?? null) == null;
        // fieldConfig ã¨ key ãŒä¸€è‡´ã™ã‚‹ã‚‚ã®ãŒã‚ã‚‹ã‹
        const role = fieldConfig[key];
        // ãƒ©ãƒ™ãƒ«
        if (needLabel) {
          if (role) return role["label"];
          return key;
        }
        // value ãŒã‚ã‚‹å ´åˆã¯ HTMLè¦ç´ ï¼ˆinputï¼‰ã‚’è¿”ã™
        if (!role) return createInput(id, value);

        if (Object.hasOwnProperty.call(role, "selection")) {
          // é¸æŠè‚¢ãŒã‚ã‚‹å ´åˆã¯ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒªã‚¹ãƒˆã‚’ä½œæˆ
          return createDoropdown(id, value, role.selection);
        }

        switch (typeof value) {
          case "boolean":
            return createRadio(id, value);
          case "number":
            return createNumberInput(id, value, role);
          case "string":
            // æ•°å€¤ã«å¤‰æ›å¯èƒ½ãªã‚‰æ•°å€¤å…¥åŠ›
            if (isNumber(role["initial"])) {
              return createNumberInput(id, value, role);
            }
            return createTextInput(id, value, role);
          case "object":
          default:
            return createInput(id, value);
        }
      }

      // å€¤ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰
      function onChangeValue(i, key, value) {
        if (defineSample) {
          const defineChangeStyle =
            typeof changeStyle !== "undefined" && changeStyle !== null && Object.keys(changeStyle).length > 0;
          if (defineChangeStyle) {
            // changeStyleã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¤ãƒ†ãƒ¬ãƒ¼ãƒˆã™ã‚‹
            for (let combo in changeStyle) {
              //if (!changeStyle.hasOwnProperty(key)) continue;
              if (combo !== key) continue;

              const rule = changeStyle[key];

              rule.targets.forEach((target) => {
                // keyã«å¯¾å¿œã™ã‚‹HTMLè¦ç´ ã‚’å–å¾—
                const inputElement = document.getElementById(`${target}-${i}`);
                const inputElementValue = document.getElementById(`${target}-${i}-value`);
                // æ¡ä»¶ãŒä¸€è‡´ã—ãŸå ´åˆã€æŒ‡å®šã—ãŸé …ç›®ã‚’è¡¨ç¤º/éè¡¨ç¤ºã«åˆ‡ã‚Šæ›¿ãˆã‚‹
                const bool = rule.condition === "==" ? value === rule.if : value !== rule.if;
                if (bool) {
                  inputElement.classList.add(rule.toggleclass);
                  inputElementValue.classList.add(rule.toggleclass);
                } else {
                  inputElement.classList.remove(rule.toggleclass);
                  inputElementValue.classList.remove(rule.toggleclass);
                }
              });
            }
          }
        }
      }
      // --------------------------------------------
      // Helper
      function isNumber(input) {
        return input !== "" && !isNaN(Number(input));
      }

      function getType(input) {
        if (typeof input !== "string" && typeof input !== "number") return typeof input;
        if (typeof input == "string" && !isNumber(input)) return "string";
        const numberString = typeof input === "number" ? input.toString() : input;
        if (!numberString.includes(".")) {
          return "int";
        } else {
          return "float";
        }
      }

      // --------------------------------------------
      // Json(Value) ã‚’HTML(Form)ã«å¤‰æ›
      function createInput(id, value) {
        const input = document.createElement("input");
        input.setAttribute("name", id);
        return input;
      }

      function createTextInput(id, value, role) {
        const inputText = createInput(id, value);
        inputText.setAttribute("value", value);
        inputText.setAttribute("type", "text");
        inputText.className = "w-100";
        if (role["pattern"]) inputText.setAttribute("pattern", role["pattern"]);
        const length = role["map"];
        if (length) {
          if (length.min) inputText.setAttribute("minlength", length.min);
          if (length.max) inputText.setAttribute("maxlength", length.max);
        }
        return inputText;
      }

      function createNumberInput(id, value, role) {
        const inputNumber = createInput(id, value);
        inputNumber.setAttribute("type", "number");
        inputNumber.className = "d-inline";

        // å…¥ã‚Œå­ã®å ´åˆã¯ã€å­ã®å€¤ã‚’å‚ç…§ã™ã‚‹
        let initial = role["initial"];
        if (typeof role["initial"] === "object") {
          const splits = id.split("-");
          if (splits.length < 2) return null;
          initial = role["initial"][splits[splits.length - 2]];
        }
        initial = initial === 0 ? value : initial;
        const type = getType(initial);

        if (type !== "int" && type !== "float") {
          return createTextInput(id, value, role);
        }
        if (type == "float") {
          inputNumber.setAttribute("step", 0.01); // float
        } else {
          inputNumber.setAttribute("step", 1); // int
        }
        const map = role["map"];
        if (map) {
          if (map.min != undefined) inputNumber.setAttribute("min", map.min);
          if (map.max != undefined) inputNumber.setAttribute("max", map.max);
        }
        inputNumber.setAttribute("value", Number(value));
        return inputNumber;
      }

      function createCheck(id, value) {
        const input = document.createElement("input");
        input.setAttribute("type", "checkbox");
        input.setAttribute("name", id);
        if (value) input.setAttribute("checked", "checked");
        return input;
      }
      function createRadio(id, value) {
        const div = document.createElement("div");
        div.className = "btn-group";
        div.setAttribute("role", "group");
        div.setAttribute("aria-label", "Basic radio toggle button group");
        div.innerHTML = `
        <input type="radio" class="btn-check" name="${id}" id="${id}-on" autocomplete="off" value="${value}" ${
          value ? "checked" : ""
        }>
        <label class="btn btn-outline-primary" for="${id}-on">ã™ã‚‹</label>
        <input type="radio" class="btn-check" name="${id}" id="${id}-off" autocomplete="off" value="${value}" ${
          !value ? "checked" : ""
        }>
        <label class="btn btn-outline-primary" for="${id}-off">ã—ãªã„</label>`;
        return div;
      }
      function createDoropdown(id, value, array) {
        const select = document.createElement("select");
        select.setAttribute("name", id);
        select.innerHTML = `<option selected>Open this select menu</option>`;
        array.forEach((element) => {
          const option = document.createElement("option");
          option.setAttribute("value", element);
          option.textContent = element;
          if (element === value) option.setAttribute("selected", "selected");
          select.appendChild(option);
        });
        return select;
      }

      // --------------------------------------------
      // Json(Array) ã‚’HTML(dl)ã§è¡¨ç¤ºã™ã‚‹
      function setElem(coverage, from = 0) {
        // éåŒæœŸã®å‡¦ç†ã®ãŸã‚ã€forEachã®ä»£ã‚ã‚Šã«for...ofãƒ«ãƒ¼ãƒ—ã‚’ä½¿ç”¨
        for (let i = 0; i < coverage.length; i++) {
          const index = i + from;
          const object = coverage[i];

          // åŒºåˆ‡ã‚Šç·š
          const parent_dt = document.createElement("dt");
          parent_dt.className = "border-top pt-1 float-start";
          parent_dt.innerHTML = `<span id="del-${index}" class="del material-symbols-outlined">delete</span>`;
          parent.appendChild(parent_dt);
          // Unit
          const parent_dd = document.createElement("dd");
          parent_dd.className = "border-top p-1 m-0";

          const form = document.createElement("form");
          form.name = `form-${index}`;
          form.className = "needs-validation";

          // ãƒã‚¹ãƒˆã•ã‚ŒãŸJSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‡¦ç†
          form.appendChild(createHtmlFromNestedObject(object, index));

          parent_dd.appendChild(form);
          parent.appendChild(parent_dd);
        }
        return parent;
      }

      // ãƒã‚¹ãƒˆã•ã‚ŒãŸJSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‡¦ç†
      function createHtmlFromNestedObject(object, index, path = []) {
        const dl = document.createElement("dl");
        dl.className = "row m-0 p-0";

        for (const key in object) {
          if (Object.hasOwnProperty.call(object, key)) {
            // ç”Ÿæˆã•ã‚Œã‚‹HTMLè¦ç´ ã®idã¯ parentKey-nestedKey-indexã«ãªã‚Šã¾ã™
            const newPath = [...path, key];
            const pathString = newPath.join("-");
            const parentKey = path.length ? path[0] : key;
            // è¦‹å‡ºã—
            const dt = document.createElement("dt");
            dt.id = `${pathString}-${index}`;
            dt.className = "col-3 pt-1 bg-light";
            dt.style = "border-top: 1px solid #fff;";
            dt.textContent = translate(dt.id, key) ?? key; // ç¿»è¨³
            dl.appendChild(dt);
            // å†…å®¹
            const dd = document.createElement("dd");
            dd.id = `${pathString}-${index}-value`;
            dd.className = "col-9 pt-1";
            // // ãƒã‚¹ãƒˆã•ã‚ŒãŸJSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
            if (typeof object[key] === "object") {
              // å†å¸°çš„ã«å‡¦ç†
              dd.appendChild(createHtmlFromNestedObject(object[key], index, newPath));
            } else {
              const element = translate(dt.id, parentKey, object[key]); // ç¿»è¨³
              // HTMLè¦ç´ ã‚’è¿”ã™
              if (element.outerHTML) {
                dd.innerHTML = element.outerHTML;
              } else {
                const textNode = document.createTextNode(element);
                dd.appendChild(textNode);
              }
            }
            dl.appendChild(dd);
          }
        }
        return dl;
      }

      // æ–°ã—ã„Unitã‚’è¿½åŠ 
      function init(sample) {
        const obj = {};
        // æ¸¡ã•ã‚ŒãŸã‚µãƒ³ãƒ—ãƒ«ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’å†ç¾
        const keys = Object.keys(sample);
        const values = Object.values(sample);
        // åˆæœŸå€¤ãŒå®šç¾©ã•ã‚ŒãŸã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
        const hasInitial = values.some((value) => typeof value === "object" && hasOwnProperty.call(value, "initial"));
        for (let i = 0; i < keys.length; i++) {
          const key = keys[i];
          const value = sample[key];
          // åˆæœŸå€¤ãŒå®šç¾©ã•ã‚ŒãŸã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ãªã‚‰
          if (hasInitial) {
            // å¿…é ˆé …ç›®ã®ã¿
            if (!hasOwnProperty.call(value, "required") || value.required) {
              // åˆæœŸå€¤ã‚’ã‚»ãƒƒãƒˆ
              obj[key] = value.initial;
            }
          } else {
            // æ¸¡ã•ã‚ŒãŸã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾ã‚»ãƒƒãƒˆ
            obj[key] = value;
          }
        }
        return obj;
      }

      // --------------------------------------------
      // [æœªä½¿ç”¨] é€ä¿¡ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã‚‰ Form ã®å…¥åŠ›å€¤(forms)ã§ JSON(data)ã‚’ç½®ãæ›ãˆ
      function updateData(element) {
        let index = 0;
        // HTMLCollectionã«ã¯ forEach ãŒå­˜åœ¨ã—ãªã„ã®ã§ã€Array.from() ã§é…åˆ—ã«å¤‰æ›
        Array.from(document.forms).forEach((unit) => {
          if (unit.name === "editForm") return; // ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡ãƒœã‚¿ãƒ³ã‚’é™¤å¤–
          let formData = new FormData(unit); // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
          let object = {};
          formData.forEach((value, key) => {
            const revert = revert(value, key);
            object[revert.key] = revert.value;
          });
          data[index] = object;
          index++;
        });
      }

      // å€¤ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰ Form ã®å…¥åŠ›å€¤(forms[i][key])ã§ JSON(data[i][key]) ã‚’ç½®ãæ›ãˆ
      function onChange(element) {
        if (element.name.split("-").length == 2) {
          // element.name ã‹ã‚‰ key ã¨ index ã‚’å–å¾—
          const original = revert(element.value, element.name, element.type);
          // JSON(data[i][key]) ã‚’ Form(forms[i][key]) ã§ä¸Šæ›¸ã
          if (data[original.index][original.key] != original.value) {
            data[original.index][original.key] = original.value;
          }
          // UIå´ã®å‡¦ç†ï¼ˆè¡¨ç¤ºãƒ»éè¡¨ç¤ºã®åˆ‡ã‚Šæ›¿ãˆãªã©ï¼‰
          if (typeof onChangeValue === "function") {
            onChangeValue(original.index, original.key, original.value);
          }
        }
      }

      // FormData(forms[i][key]) ã‚’ JSON(data[i][key]) ã«å¤‰æ›
      function revert(value, id, type = "text") {
        const splits = id.split("-");
        if (splits.length < 2) return null;

        // element.name ã‹ã‚‰ key ã¨ index ã‚’å–å¾—
        const index = splits.pop();
        const parentKey = splits.pop();

        // valueã‚’é©åˆ‡ãªå‹ã«å¤‰æ›
        switch (type) {
          case "number":
            value = Number(value);
            break;
          case "radio":
            if (typeof value === "string") {
              value = value === "true" ? true : false;
            }
            break;
          case "checkbox":
            if (typeof value === "string") {
              value = value === "on" ? true : false;
            }
            break;
          case "select-multiple":
            value = Array.from(value);
            break;
          default:
            value = value;
            break;
        }

        // æ·±ã„éšå±¤ã«å¯¾å¿œ
        while (splits.length > 0) {
          const nestedKey = splits.pop();
          value = { [nestedKey]: value };
        }

        return { index: index, key: parentKey, value: value };
      }

      // --------------------------------------------
      // [æ›´æ–°] HTMLãŠã‚ˆã³ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’æ›´æ–°
      function reload(coverage, from = 0) {
        parent.innerHTML = "";
        // Jsonã‚’HTML(dl)ã§è¡¨ç¤ºã™ã‚‹
        form.appendChild(setElem(coverage, from));
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’æ›´æ–°
        setChangeEvent();
        setRemoveEvent();
      }

      // [æ›´æ–°] å€¤ãŒå¤‰æ›´ã•ã‚ŒãŸã¨ãã«JSONã‚’æ›´æ–°
      function setChangeEvent() {
        let inputs = form.getElementsByTagName("input") ? Array.from(form.getElementsByTagName("input")) : [];
        let dropdowns = form.getElementsByTagName("select") ? Array.from(form.getElementsByTagName("select")) : [];
        [...inputs, ...dropdowns].forEach((element) => {
          onChange(element); // èª­ã¿è¾¼ã¿æ™‚
          element.addEventListener("change", function (e) {
            onChange(element); // å¤‰æ›´æ™‚
          });
        });
      }

      // [æ›´æ–°] å‰Šé™¤ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ãã«JSONã‚’æ›´æ–°
      function setRemoveEvent() {
        let removeButtons = document.getElementsByClassName("del")
          ? Array.from(document.getElementsByClassName("del"))
          : [];
        removeButtons.forEach((element) => {
          element.addEventListener("click", function (e) {
            const index = element.id.split("-").pop();
            console.log("å‰Šé™¤", index);
            // å‰Šé™¤
            data.splice(Number(index), 1);
            // å†æç”»
            reload(data);
          });
        });
      }
      // --------------------------------------------
      // File æ“ä½œ
      // --------------------------------------------
      // ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜(FILE API)
      function saveFile(json) {
        var blob = new Blob([JSON.stringify(json, null, 2)], { type: "application/json" });
        var link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = jsonFile.split("/").pop();
        link.click();
      }
      // ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜(File System Access API: File API ã¨ç•°ãªã‚Šä¸Šæ›¸ãä¿å­˜ãŒå¯èƒ½ï¼‰
      async function saveFileSystem(json) {
        const writable = await fileHandle.createWritable();
        await writable.write(JSON.stringify(json, null, 2));
        await writable.close();
      }
      // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã
      async function OpenFile() {
        const file = await fileHandle.getFile();
        const contents = await file.text();
        data = JSON.parse(contents);
        // [æ›´æ–°] HTMLãŠã‚ˆã³ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’é…ç½®
        reload(data);
        // UIã‚’æ›´æ–°
        enableUI();
      }
      // ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã£ãŸã‚‰ã€ä¿å­˜&è¿½åŠ ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
      function enableUI() {
        saveBtn.disabled = false;
        saveBtn.classList.replace("btn-secondary", "btn-primary");
        openBtn.classList.replace("btn-primary", "btn-outline-primary");
        reloadBtn.classList.remove("d-none");
        addBtn.classList.remove("d-none");
      }
      // ============================================
      // Main
      // --------------------------------------------
      let fileHandle;
      let data = [];
      const form = document.getElementById("editForm");
      const parent = document.getElementById("container");
      const openBtn = document.getElementById("open");
      const reloadBtn = document.getElementById("reload");
      const saveBtn = document.getElementById("save");
      const addBtn = document.getElementById("add");

      // [ã‚¤ãƒ™ãƒ³ãƒˆ] ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã„ãŸã‚‰
      openBtn.addEventListener("click", async (e) => {
        [fileHandle] = await window.showOpenFilePicker();
        OpenFile();
      });
      reloadBtn.addEventListener("click", async (e) => {
        OpenFile();
      });
      // [ã‚¤ãƒ™ãƒ³ãƒˆ] é€ä¿¡ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãç·¨é›†å¾Œã®JSONã‚’å–å¾—
      form.addEventListener("submit", async (e) => {
        event.preventDefault();
        let valid = true;
        Array.from(document.forms).forEach((unit) => {
          // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®è©³ç´°æƒ…å ±ã‚’å–å¾—ã—ãŸã„å ´åˆã¯checkValidityã®ä»£ã‚ã‚Šã«reportValidityã‚’ä½¿ç”¨
          if (unit.reportValidity()) {
            console.log("Form is valid!");
          } else {
            console.log("Form is invalid!");
            event.preventDefault(); // ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®é€ä¿¡å‹•ä½œã‚’é˜²æ­¢
            event.stopPropagation();
            valid = false;
          }
        });
        if (valid) {
          saveFile(data);
          //saveFileSystem(data);
        }
      });

      // [ã‚¤ãƒ™ãƒ³ãƒˆ] è¿½åŠ ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãæ–°ã—ã„Unitã‚’è¿½åŠ 
      addBtn.addEventListener("click", function (e) {
        event.preventDefault();
        // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚Œã°ãã‚Œã‚’ä½¿ã†
        const unit = defineSample ? init(fieldConfig) : data[0];
        data.push(unit);
        reload(data);
      });
    </script>
  </body>
</html>
