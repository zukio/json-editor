<!DOCTYPE html>
<html lang="ja">
  <title>Edit Settings</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
    crossorigin="anonymous"
  />
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0"
  />

  <body class="p-5">
    <div class="container">
      <div class="text-end mb-3">
        <a href="#" id="reload" class="d-none" onclick="window.location.reload(true);">èª­ã¿ç›´ã™ğŸ”„</a>
      </div>
      <pre id="debug"></pre>
      <form id="editForm" name="editForm" class="position-relative needs-validation">
        <button id="save" class="btn btn-secondary w-100" type="submit" disabled>
          Save
          <span class="material-symbols-outlined align-middle"> download </span>
        </button>
        <dl id="container" class="pt-3 m-0"></dl>
      </form>
      <div class="w-100 d-flex justify-content-center">
        <button id="add" class="btn btn-outline-primary rounded-circle d-none" type="button">+</button>
      </div>
    </div>
    <script src="./modifiedParts.js"></script>
    <script src="./renderHtml.js"></script>
    <script>
      // ============================================
      // Main
      // --------------------------------------------
      let data = [];
      let fieldConfig = null;
      let changeStyle = null;

      const form = document.getElementById("editForm");
      const parent = document.getElementById("container");
      // const openBtn = document.getElementById("open");
      const reloadBtn = document.getElementById("reload");
      const saveBtn = document.getElementById("save");
      const addBtn = document.getElementById("add");

      // ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚
      window.api.on("mounted", (apidata) => {
        // data.jsonã®å†…å®¹ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚
        data = apidata.data;
        fieldConfig = apidata.sample ?? {};
        changeStyle = apidata.changeStyle ?? {};

        // [ã‚¤ãƒ™ãƒ³ãƒˆ] HTMLãŠã‚ˆã³ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’é…ç½®
        reload(data);
        // UIã‚’æ›´æ–°
        enableUI();
      });

      // [ã‚¤ãƒ™ãƒ³ãƒˆ] é€ä¿¡ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãç·¨é›†å¾Œã®JSONã‚’å–å¾—
      form.addEventListener("submit", async (e) => {
        event.preventDefault();
        let valid = true;
        Array.from(document.forms).forEach((unit) => {
          // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®è©³ç´°æƒ…å ±ã‚’å–å¾—ã—ãŸã„å ´åˆã¯checkValidityã®ä»£ã‚ã‚Šã«reportValidityã‚’ä½¿ç”¨
          if (unit.reportValidity()) {
            console.log("Form is valid!");
          } else {
            console.log("Form is invalid!");
            event.preventDefault(); // ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®é€ä¿¡å‹•ä½œã‚’é˜²æ­¢
            event.stopPropagation();
            valid = false;
          }
        });
        if (valid) {
          // ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹
          window.api.send("request-save", data);
        }
      });

      // [ã‚¤ãƒ™ãƒ³ãƒˆ] è¿½åŠ ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãæ–°ã—ã„Unitã‚’è¿½åŠ 
      addBtn.addEventListener("click", function (e) {
        event.preventDefault();
        // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚Œã°ãã‚Œã‚’ä½¿ã†
        const unit = defineSample ? init(fieldConfig) : data[0];
        data.push(unit);
        reload(data);
      });

      // ============================================
      // ä»¥ä¸‹ã¯ç·¨é›†ä¸è¦
      // --------------------------------------------
      // ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºç”¨ã‚µãƒ³ãƒ—ãƒ«ãŒå®£è¨€ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹
      const defineSample = () =>
        typeof fieldConfig !== "undefined" && fieldConfig !== null && Object.keys(fieldConfig).length > 0;

      // --------------------------------------------
      // ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã£ãŸã‚‰ã€ä¿å­˜&è¿½åŠ ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
      function enableUI() {
        saveBtn.disabled = false;
        saveBtn.classList.replace("btn-secondary", "btn-primary");
        //openBtn.classList.replace("btn-primary", "btn-outline-primary");
        reloadBtn.classList.remove("d-none");
        addBtn.classList.remove("d-none");
      }

      // --------------------------------------------
      // è¿½åŠ ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã‚‰æ–°ã—ã„Unitã‚’è¿½åŠ 
      function init(sample) {
        const obj = {};
        // æ¸¡ã•ã‚ŒãŸã‚µãƒ³ãƒ—ãƒ«ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’å†ç¾
        const keys = Object.keys(sample);
        const values = Object.values(sample);
        // åˆæœŸå€¤ãŒå®šç¾©ã•ã‚ŒãŸã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
        const hasInitial = values.some((value) => typeof value === "object" && hasOwnProperty.call(value, "initial"));
        for (let i = 0; i < keys.length; i++) {
          const key = keys[i];
          const value = sample[key];
          // åˆæœŸå€¤ãŒå®šç¾©ã•ã‚ŒãŸã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ãªã‚‰
          if (hasInitial) {
            // å¿…é ˆé …ç›®ã®ã¿
            if (!hasOwnProperty.call(value, "required") || value.required) {
              // åˆæœŸå€¤ã‚’ã‚»ãƒƒãƒˆ
              obj[key] = value.initial;
            }
          } else {
            // æ¸¡ã•ã‚ŒãŸã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾ã‚»ãƒƒãƒˆ
            obj[key] = value;
          }
        }
        return obj;
      }

      // --------------------------------------------
      // å€¤ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰ Form ã®å…¥åŠ›å€¤(forms[i][key])ã§ JSON(data[i][key]) ã‚’ç½®ãæ›ãˆ
      function onChange(element) {
        if (element.name.split("-").length == 2) {
          // element.name ã‹ã‚‰ key ã¨ index ã‚’å–å¾—
          const original = revert(element.value, element.name, element.type);
          // JSON(data[i][key]) ã‚’ Form(forms[i][key]) ã§ä¸Šæ›¸ã
          if (data[original.index][original.key] != original.value) {
            data[original.index][original.key] = original.value;
          }
          // UIå´ã®å‡¦ç†ï¼ˆè¡¨ç¤ºãƒ»éè¡¨ç¤ºã®åˆ‡ã‚Šæ›¿ãˆãªã©ï¼‰
          if (typeof onChangeValue === "function") {
            onChangeValue(original.index, original.key, original.value);
          }
        }
      }

      // FormData(forms[i][key]) ã‚’ JSON(data[i][key]) ã«å¤‰æ›
      function revert(value, id, type = "text") {
        const splits = id.split("-");
        if (splits.length < 2) return null;

        // element.name ã‹ã‚‰ key ã¨ index ã‚’å–å¾—
        const index = splits.pop();
        const parentKey = splits.pop();

        // valueã‚’é©åˆ‡ãªå‹ã«å¤‰æ›
        switch (type) {
          case "number":
            value = Number(value);
            break;
          case "radio":
            if (typeof value === "string") {
              value = value === "true" ? true : false;
            }
            break;
          case "checkbox":
            if (typeof value === "string") {
              value = value === "on" ? true : false;
            }
            break;
          case "select-multiple":
            value = Array.from(value);
            break;
          default:
            value = value;
            break;
        }
        // æ·±ã„éšå±¤ã«å¯¾å¿œ
        while (splits.length > 0) {
          const nestedKey = splits.pop();
          value = { [nestedKey]: value };
        }

        return { index: index, key: parentKey, value: value };
      }

      // --------------------------------------------
      // [æ›´æ–°] HTMLãŠã‚ˆã³ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’æ›´æ–°
      function reload(coverage, from = 0) {
        parent.innerHTML = "";
        // Jsonã‚’HTML(dl)ã§è¡¨ç¤ºã™ã‚‹
        form.appendChild(setElem(coverage, from));
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’æ›´æ–°
        setChangeEvent();
        setRemoveEvent();
      }

      // [æ›´æ–°] å€¤ãŒå¤‰æ›´ã•ã‚ŒãŸã¨ãã«JSONã‚’æ›´æ–°
      function setChangeEvent() {
        let inputs = form.getElementsByTagName("input") ? Array.from(form.getElementsByTagName("input")) : [];
        let dropdowns = form.getElementsByTagName("select") ? Array.from(form.getElementsByTagName("select")) : [];
        [...inputs, ...dropdowns].forEach((element) => {
          onChange(element); // èª­ã¿è¾¼ã¿æ™‚
          element.addEventListener("change", function (e) {
            onChange(element); // å¤‰æ›´æ™‚
          });
        });
      }

      // [æ›´æ–°] å‰Šé™¤ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ãã«JSONã‚’æ›´æ–°
      function setRemoveEvent() {
        let removeButtons = document.getElementsByClassName("del")
          ? Array.from(document.getElementsByClassName("del"))
          : [];
        removeButtons.forEach((element) => {
          element.addEventListener("click", function (e) {
            const index = element.id.split("-").pop();
            // å‰Šé™¤
            data.splice(index, 1);
            // å†æç”»
            reload(data);
          });
        });
      }
    </script>
  </body>
</html>
